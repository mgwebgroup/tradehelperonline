{% extends "base.html.twig" %}
{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('market_survey')  }}
{% endblock %}
{% block body %}
    {% set ins_d_ct = 0 %}
    {% set ins_wk_ct = 0 %}
    {% set ins_mo_ct = 0 %}
    {% set order_of_expr = ['Ins D & Up', 'Ins Wk & Up', 'Ins Mo & Up', 'Ins D', 'Ins D & Dwn', 'Ins Wk & Dwn', 'Ins Mo & Dwn', 'D Hammer', 'Wk Hammer', 'Mo Hammer', 'Ins Wk', 'D Shtng Star', 'Wk Shtng Star', 'Mo Shtng Star', 'Ins Mo', 'D Bullish Eng', 'D Bearish Eng', 'Wk Bullish Eng', 'Wk Bearish Eng', 'Mo Bullish Eng', 'Mo Bearish Eng', 'D Hammer & Up', 'D Shtng Star & Down'] %}
    {% set highlighted_cols = ['Ins D', 'D Hammer', 'Wk Hammer', 'Mo Hammer', 'D Shtng Star', 'Wk Shtng Star', 'Mo Shtng Star', 'D Bullish Eng', 'D Bearish Eng', 'Wk Bullish Eng', 'Wk Bearish Eng', 'Mo Bullish Eng', 'Mo Bearish Eng'] %}
    {% set order_of_quartets = ['Mo BO','Pos on Mo','Neg on Mo','Mo BD','Wk BO','Pos on Wk','Neg on Wk','Wk BD','D BO','Pos on D','Neg on D','D BD'] %}
    <div class="page-wrapper container-fluid">
        <section class="announcements border-bottom">
            <div class="row">
                <div class="col-2"><h4>{{ date|date('M d, Y') }}</h4></div>
                <div class="col">
{#                    {% for error in errors %}#}
{#                        <p class="text-dander bg-warning border border-danger rounded p-1 text-center">{{ error }}</p>#}
{#                    {% endfor %}#}
                </div>
            </div>
        </section>
{#    {% if errors is empty %}#}
        <section class="survey mt-2">
            <div class="row">
                <div class="col-4 offset-4"><h5 class="text-center">Market Survey</h5></div>
                <div class="col-1 ml-auto"><h6 class="text-right mb-0 mt-2">Score: {{ score }}</h6></div>
                <div class="col-1"><h6 class="text-right mb-0 mt-2">Delta: {{ score_delta }}</h6></div>
            </div>
            <table class="table table-sm">
                <thead>
                <tr>
                    {% for expression in order_of_expr if attribute(survey, expression) is defined %}
                        {% set add_class = expression in highlighted_cols ? 'table-warning' : null %}
                        <th scope="col" class="text-center {{ add_class }}">{{ expression }}</th>
                        {% if 'Ins D' == expression %}
                            {% set ins_d_ct = attribute(survey, expression)|length %}
                        {% endif %}
                        {% if 'Ins Wk' == expression %}
                            {% set ins_wk_ct = attribute(survey, expression)|length %}
                        {% endif %}
                        {% if 'Ins Mo' == expression %}
                            {% set ins_mo_ct = attribute(survey, expression)|length %}
                        {% endif %}
                    {% endfor %}
                    {% set table_max_rows = max(ins_d_ct, ins_wk_ct, ins_mo_ct) %}
                </tr>
                <tr>
                    {% for expression in order_of_expr if attribute(survey, expression) is defined %}
                        {% set add_class = expression in highlighted_cols ? 'table-warning' : null %}
                        <th scope="col" class="text-center {{ add_class }}">{{ attribute(survey, expression)|length }}</th>
                    {% endfor %}
                </tr>
                </thead>
                <tbody>
                {% for i in 0..table_max_rows %}
                    <tr>
                        {% for expression in order_of_expr if attribute(survey, expression) is defined %}
                            {% set list = attribute(survey, expression) %}
                            {% set add_class = expression in highlighted_cols ? 'table-warning' : null %}
                            <td class="text-center {{ add_class }}">{{ list[i] is defined ? attribute(list[i], 'symbol') : '' }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </section>
        <section class="breakouts mt-2">
            <div class="row">
                <div class="col">
                    <h6 class="text-center">Ins D, Ins Wk, Ins Mo Breakouts/Breakdowns</h6>
                </div>
                <div class="col">
                    <h6 class="text-center">AS Breakouts/Breakdowns</h6>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <table class="table table-sm">
                        <thead>
                        <tr>
                            <th>IM</th><th>{{insmo_bobd.count}}</th><th></th><th></th>
                            <th>IW</th><th>{{inswk_bobd.count}}</th><th></th><th></th>
                            <th>ID</th><th>{{insd_bobd.count}}</th><th></th><th></th>
                        </tr>
                        <tr>
                            {% for expr_name in order_of_quartets %}
                                <th>{{ expr_name }}</th>
                            {% endfor %}
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            {% for i in 0..3 %}
                                {% set expr_name = cycle(order_of_quartets, i) %}
                                <td>{{ insmo_bobd.survey is defined ? attribute(insmo_bobd.survey, expr_name)|length : 0 }}</td>
                            {% endfor %}
                            {% for i in 4..7 %}
                                {% set expr_name = cycle(order_of_quartets, i) %}
                                <td>{{ inswk_bobd.survey is defined ? attribute(inswk_bobd.survey, expr_name)|length : 0 }}</td>
                            {% endfor %}
                            {% for i in 8..11 %}
                                {% set expr_name = cycle(order_of_quartets, i) %}
                                <td>{{ insd_bobd.survey is defined ? attribute(insd_bobd.survey, expr_name)|length : 0 }}</td>
                            {% endfor %}
                        </tr>
                        <tr>
                            {% for i in 0..3 %}
                                {% set expr_name = cycle(order_of_quartets, i) %}
                                <td>{{ insmo_bobd.survey is defined ? (attribute(insmo_bobd.survey, expr_name)|length / insmo_bobd.count * 100)|number_format(2) ~ '%' : 'N/A' }}</td>
                            {% endfor %}
                            {% for i in 4..7 %}
                                {% set expr_name = cycle(order_of_quartets, i) %}
                                <td>{{ inswk_bobd.survey is defined ? (attribute(inswk_bobd.survey, expr_name)|length / inswk_bobd.count * 100)|number_format(2) ~ '%' : 'N/A' }}</td>
                            {% endfor %}
                            {% for i in 8..11 %}
                                {% set expr_name = cycle(order_of_quartets, i) %}
                                <td>{{ insd_bobd.survey is defined ? (attribute(insd_bobd.survey, expr_name)|length / insd_bobd.count * 100)|number_format(2) ~ '%' : 'N/A' }}</td>
                            {% endfor %}
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="col">
                    <table class="table table-sm">
                        <thead>
                        <tr>
                            <th>IM</th><th></th><th></th><th></th>
                            <th>IW</th><th></th><th></th><th></th>
                            <th>ID</th><th></th><th></th><th></th>
                        </tr>
                        <tr>
                            {% for expr_name in order_of_quartets %}
                                <th>{{ expr_name }}</th>
                            {% endfor %}
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            {% for i in 0..11 %}
                                {% set expr_name = cycle(order_of_quartets, i) %}
                                <td>{{ as_bobd.survey is defined ? attribute(as_bobd.survey, expr_name)|length : 0 }}</td>
                            {% endfor %}
                        </tr>
                        <tr>
                            {% for i in 0..11 %}
                                {% set expr_name = cycle(order_of_quartets, i) %}
                                <td>{{ as_bobd.count > 0 ? (attribute(as_bobd.survey, expr_name)|length / as_bobd.count * 100)|number_format(2) ~ '%' : 'N/A' }}</td>
                            {% endfor %}
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        <section class="market-score">
            <div class="row">
                <div class="col">
                    <h6 class="text-center">Market Score MTD</h6>
                    <table class="table table-sm">
                        <thead>
                        <tr>
                            <th>Date</th><th>Score</th><th>Std Devs from Avg</th><th>Delta</th><th>Std Devs from Avg</th><th>SPY</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% if score_table_mtd.table is defined %}
                            {% for record in score_table_mtd.table %}
                                <tr>
                                    <td>{{record.date|date('m/d/y')}}</td>
                                    {% set add_class = record.score == attribute(score_table_mtd.summary, 'score-max') ? 'table-success': null %}
                                    {% set add_class = record.score == attribute(score_table_mtd.summary, 'score-min') ? 'table-danger': add_class %}
                                    <td class="{{ add_class }}">{{record.score|number_format(2)}}</td><td>{{ attribute(record, 'score-std_div_qty')|number_format(2) }}</td>
                                    {% set add_class = record.delta == attribute(score_table_mtd.summary, 'delta-max') ? 'table-success': null %}
                                    {% set add_class = record.delta == attribute(score_table_mtd.summary, 'delta-min') ? 'table-danger': add_class %}
                                    <td class="{{ add_class }}">{{ record.delta|number_format(2) }}</td><td>{{ attribute(record, 'delta-std_div_qty')|number_format(2) }}</td>
                                    {% set add_class = attribute(record, 'delta-std_div_qty') > 1 or attribute(record, 'delta-std_div_qty') < -1 ? 'table-active' : null %}
                                    <td class="{{ add_class }}">{{ record.P|number_format(2) }}</td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                        {% if score_table_mtd.summary is defined %}
                            <tr class="table-info">
                                <td>Avg</td><td>{{ attribute(score_table_mtd.summary, 'score-avg')|number_format(2) }}</td><td></td>
                                <td>{{ attribute(score_table_mtd.summary, 'delta-avg')|number_format(2) }}</td><td></td><td>{{ attribute(score_table_mtd.summary, 'P-avg')|number_format(2) }}</td>
                            </tr>
                            <tr>
                                <td>Max</td><td>{{ attribute(score_table_mtd.summary, 'score-max')|number_format(2) }}</td><td></td>
                                <td>{{ attribute(score_table_mtd.summary, 'delta-max')|number_format(2) }}</td><td></td><td></td>
                            </tr>
                            <tr>
                                <td>Min</td><td>{{ attribute(score_table_mtd.summary, 'score-min')|number_format(2) }}</td><td></td>
                                <td>{{ attribute(score_table_mtd.summary, 'delta-min')|number_format(2) }}</td><td></td><td></td>
                            </tr>
                            <tr>
                                <td>Std Dev</td><td>{{ attribute(score_table_mtd.summary, 'score-std_div')|number_format(2) }}</td><td></td>
                                <td>{{ attribute(score_table_mtd.summary, 'delta-std_div')|number_format(2) }}</td><td></td><td></td>
                            </tr>
                            <tr>
                                <td>Days Pos</td><td>{{ attribute(score_table_mtd.summary, 'score-days_pos') }}</td><td></td>
                                <td></td><td></td><td></td>
                            </tr>
                            <tr>
                                <td>Days Neg</td><td>{{ attribute(score_table_mtd.summary, 'score-days_neg') }}</td><td></td>
                                <td></td><td></td><td></td>
                            </tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="col">
                    <h6 class="text-center">Market Score 21 day</h6>
                    <table class="table table-sm">
                        <thead>
                        <tr>
                            <th>Date</th><th>Score</th><th>Std Devs from Avg</th><th>Delta</th><th>Std Devs from Avg</th><th>SPY</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% if score_table_rolling.table is defined %}
                            {% for record in score_table_rolling.table %}
                                <tr>
                                    <td>{{record.date|date('m/d/y')}}</td>
                                    {% set add_class = record.score == attribute(score_table_rolling.summary, 'score-max') ? 'table-success': null %}
                                    {% set add_class = record.score == attribute(score_table_rolling.summary, 'score-min') ? 'table-danger': add_class %}
                                    <td class="{{ add_class }}">{{record.score|number_format(2)}}</td><td>{{ attribute(record, 'score-std_div_qty')|number_format(2) }}</td>
                                    {% set add_class = record.delta == attribute(score_table_rolling.summary, 'delta-max') ? 'table-success': null %}
                                    {% set add_class = record.delta == attribute(score_table_rolling.summary, 'delta-min') ? 'table-danger': add_class %}
                                    <td class="{{ add_class }}">{{ record.delta|number_format(2) }}</td><td>{{ attribute(record, 'delta-std_div_qty')|number_format(2) }}</td>
                                    {% set add_class = attribute(record, 'delta-std_div_qty') > 1 or attribute(record, 'delta-std_div_qty') < -1 ? 'table-active' : null %}
                                    <td class="{{ add_class }}">{{ record.P|number_format(2) }}</td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                        {% if score_table_rolling.summary is defined %}
                            <tr class="table-info">
                                <td>Avg</td><td>{{ attribute(score_table_rolling.summary, 'score-avg')|number_format(2) }}</td><td></td>
                                <td>{{ attribute(score_table_rolling.summary, 'delta-avg')|number_format(2) }}</td><td></td><td>{{ attribute(score_table_rolling.summary, 'P-avg')|number_format(2) }}</td>
                            </tr>
                            <tr>
                                <td>Max</td><td>{{ attribute(score_table_rolling.summary, 'score-max')|number_format(2) }}</td><td></td>
                                <td>{{ attribute(score_table_rolling.summary, 'delta-max')|number_format(2) }}</td><td></td><td></td>
                            </tr>
                            <tr>
                                <td>Min</td><td>{{ attribute(score_table_rolling.summary, 'score-min')|number_format(2) }}</td><td></td>
                                <td>{{ attribute(score_table_rolling.summary, 'delta-min')|number_format(2) }}</td><td></td><td></td>
                            </tr>
                            <tr>
                                <td>Std Dev</td><td>{{ attribute(score_table_rolling.summary, 'score-std_div')|number_format(2) }}</td><td></td>
                                <td>{{ attribute(score_table_rolling.summary, 'delta-std_div')|number_format(2) }}</td><td></td><td></td>
                            </tr>
                            <tr>
                                <td>Days Pos</td><td>{{ attribute(score_table_rolling.summary, 'score-days_pos') }}</td><td></td>
                                <td></td><td></td><td></td>
                            </tr>
                            <tr>
                                <td>Days Neg</td><td>{{ attribute(score_table_rolling.summary, 'score-days_neg') }}</td><td></td>
                                <td></td><td></td><td></td>
                            </tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        <section class="sectors">
            <div class="row">
                <div class="col">
                    <h6 class="text-center">Sector Performance</h6>
                    {% set negative = 'text-danger' %}
                    <table class="table table-sm">
                        <col>
                        <col>
                        <col>
                        <col>
                        <col>
                        <col>
                        <col>
                        <col>
                        <col>
                        <colgroup span="5"></colgroup>
                        <col>
                        <col>
                        <thead>
                        <tr>
                            <th rowspan="2">#</th>
                            <th rowspan="2">Sector</th>
                            <th rowspan="2">Closing P, %</th>
                            <th rowspan="2">dP, %</th>
                            <th rowspan="2">dP(5), %</th>
                            <th rowspan="2">Week dP, %</th>
                            <th rowspan="2">Month dP, %</th>
                            <th rowspan="2">Quarter dP, %</th>
                            <th rowspan="2">Year dP, %</th>
                            <th colspan="5" scope="colgroup">Hist. Position Score</th>
                            <th rowspan="2">Sum</th>
                            <th rowspan="2">Gradient</th>
                        </tr>
                        <tr>
                            <th scope="col">T-4</th><th scope="col">T-3</th><th scope="col">T-2</th><th scope="col">T-1</th><th scope="col">T</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% if sector_table.table is defined %}
                            {% for sector, record in sector_table.table %}
                                <tr>
                                    <td>{{loop.index}}</td>
                                    <td>{{ sector }}</td>
                                    <td>{{ '$' ~ record.P|number_format(2) }}</td>
                                    <td>{{ include('formatters/math.twig', { value: attribute(record, 'delta P prcnt') }) }}</td>
                                    <td>{{ include('formatters/math.twig', { value: attribute(record, 'delta P(5) prcnt') }) }}</td>
                                    <td>{{ include('formatters/math.twig', { value: attribute(record, 'Wk delta P') }) }}</td>
                                    <td>{{ include('formatters/math.twig', { value: attribute(record, 'Mo delta P') }) }}</td>
                                    <td>{{ include('formatters/math.twig', { value: attribute(record, 'Qrtr delta P') }) }}</td>
                                    <td>{{ include('formatters/math.twig', { value: attribute(record, 'Yr delta P') }) }}</td>
                                    {% set hist_pos_score = attribute(record, 'Hist Pos Score') %}
                                    <td scope="col">{{ attribute(hist_pos_score, 'T-4') }}</td>
                                    <td scope="col">{{ attribute(hist_pos_score, 'T-3') }}</td>
                                    <td scope="col">{{ attribute(hist_pos_score, 'T-2') }}</td>
                                    <td scope="col">{{ attribute(hist_pos_score, 'T-1') }}</td>
                                    <td scope="col">{{ attribute(hist_pos_score, 'T') }}</td>
                                    <td>{{ attribute(record, 'Pos Score Sum')|number_format(0) }}</td>
                                    <td>{{ attribute(record, 'Pos Score Grad')|number_format(0) }}</td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                        {% if sector_table.summary is defined %}
                            {% set sector_table_summary = sector_table.summary %}
                            <tr class="table-info">
                                <td>Sum:</td><td></td><td></td>
                                <td>{{ include('formatters/math.twig', { value: attribute(sector_table_summary.sum, 'delta P prcnt') }) }}</td>
                                <td>{{ include('formatters/math.twig', { value: attribute(sector_table_summary.sum, 'delta P(5) prcnt') }) }}</td>
                                <td>{{ include('formatters/math.twig', { value: attribute(sector_table_summary.sum, 'Wk delta P') }) }}</td>
                                <td>{{ include('formatters/math.twig', { value: attribute(sector_table_summary.sum, 'Mo delta P') }) }}</td>
                                <td>{{ include('formatters/math.twig', { value: attribute(sector_table_summary.sum, 'Qrtr delta P') }) }}</td>
                                <td>{{ include('formatters/math.twig', { value: attribute(sector_table_summary.sum, 'Yr delta P') }) }}</td>
                                <td scope="col"></td>
                                <td scope="col"></td>
                                <td scope="col"></td>
                                <td scope="col"></td>
                                <td scope="col"></td>
                                <td></td>
                                <td></td>
                            </tr>
                            {% set up_down_tick = attribute(sector_table_summary, 'up_down_tick') %}
                            <tr>
                                <td>Up/Down Tick:</td><td></td><td></td><td></td>
                                <td>{{ include('formatters/math.twig', { value: attribute(up_down_tick, 'delta P(5) prcnt') }) }}</td>
                                <td>{{ include('formatters/math.twig', { value: attribute(up_down_tick, 'Wk delta P') }) }}</td>
                                <td>{{ include('formatters/math.twig', { value: attribute(up_down_tick, 'Mo delta P') }) }}</td>
                                <td>{{ include('formatters/math.twig', { value: attribute(up_down_tick, 'Qrtr delta P') }) }}</td>
                                <td>{{ include('formatters/math.twig', { value: attribute(up_down_tick, 'Yr delta P') }) }}</td>
                            </tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        <section class="as">
            <div class="row">
                <div class="col-4">
                    <h6 class="text-center">Actionable Symbols List</h6>
                    <table class="table table-sm">
                        <thead>
                        <tr>
                            <th>#</th><th>P</th><th>dP, %</th><th>Symbol</th><th>Name</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% if as_watchlist %}
                            {% set calculated_formulas = as_watchlist.calculatedFormulas %}
                            {% for instrument in as_watchlist.instruments %}
                                {% set symbol = instrument.symbol %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ calculated_formulas[symbol].P is defined ? include('formatters/math.twig', { value: attribute(calculated_formulas[symbol], 'P'), prefix: '$' }) : 'N/A' }}</td>
                                    <td>{{ attribute(calculated_formulas[symbol], 'delta P prcnt') is defined ? include('formatters/math.twig', {value: attribute(calculated_formulas[symbol], 'delta P prcnt'), positive: 'text-success'}) : 'N/A' }}</td>
                                    <td class="symbol" symbol="{{ symbol }}" date="{{ date|date('Y-m-d') }}">{{symbol}}</td>
                                    <td>{{instrument.name}}</td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td></td><td>N/A</td><td>N/A</td></tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="col-8">
                    <h6 class="text-center">Actionable Symbol Data</h6>
                    <div class="card">
                        <div class="chart-window-wrapper"></div>
                    </div>
                </div>
            </div>
        </section>
{#    {% endif %}#}
    </div>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('market_survey') }}
{% endblock %}
